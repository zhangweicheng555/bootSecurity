<!DOCTYPE html>
<html>
  <head>
    <title>外孙报销流程定义部署</title>
    <base href="#(basePath)"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    	<!-- 引入css -->
    	#@cssModel?()
  </head>
  
  <body>
	   
	   <div style="margin: 5px;">
	   		<!-- 上传部署的区域 -->
	   		<fieldset class="layui-elem-field">
			  <legend>部署上传</legend>
			  <div class="layui-field-box">
			    	<form id="ajaxForm" class="layui-form">
			    	  
				      <div class="layui-form-item">
					      
					       <div class="layui-inline">
						      <label class="layui-form-label">部署名称:</label>
						      <div class="layui-input-inline">
						        <input  name="name" id="name" required lay-verify="required" placeholder="请输入名称" autocomplete="off" class="layui-input">
						      </div>
						    </div>
						    
						    <div class="layui-inline">
						      <div class="layui-input-inline">
						        <input  id="file" type="text"  name="file" style="width:260px;">
						      </div>
						    </div>
						    
						    
						    <div class="layui-inline">
						      <label class="layui-form-label"></label>
						      <div class="layui-input-inline">
						        <button class="layui-btn" lay-submit  lay-filter="formDemo">部署</button>
						         <button type="reset" class="layui-btn layui-btn-primary">取消</button>
						      </div>
						    </div>
					  	   
					  </div>
					  
					</form>
			  </div>
			</fieldset>
			
	   		<blockquote class="layui-elem-quote"><span style="color: red;">流程部署列表</span></blockquote>
	   		<!-- 流程部署的列表 -->
	   		<table class="layui-table">
			  <colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup>
			  <thead>
			    <tr><th style="text-align: center;">部署的ID</th><th style="text-align: center;">部署名称</th><th style="text-align: center;">部署时间</th><th style="text-align: center;">操作</th></tr> 
			  </thead>
			  <tbody id="deployBody">
			  	<!-- 
			  	<tr><td>贤心</td><td>2016-11-29</td><td>人生就像是一场修行</td><td>人生就像是一场修行</td></tr>
			  	-->
			  </tbody>
			</table>
	   		
	   		<blockquote class="layui-elem-quote"><span style="color: red;">流程定义列表</span></blockquote>
  	   		<!-- 流程定义的列表 -->
	   		<table class="layui-table">
			  <colgroup><col width="14%"><col width="14%"><col width="14%"><col width="14%"><col width="14%"><col width="14%"><col width="14%"></colgroup>
			  <thead>
			    <tr><th style="text-align: center;">流程定义的ID</th><th style="text-align: center;">流程定义名称</th><th style="text-align: center;">流程定义的key</th><th style="text-align: center;">流程部署ID</th><th style="text-align: center;">流程PNG名称</th><th style="text-align: center;">流程BPMN名称</th><th style="text-align: center;">版本号</th></tr> 
			  </thead>
			  <tbody id="defineBody">
			  	<!-- <tr><center><h1 style="color: red;">暂无数据</h1></center></tr>
			    <tr><td>贤心</td><td>2016-11-29</td><td>人生就像是一场修行</td></tr>
			  	 -->
			  </tbody>
			</table>
  	   </div> 	
  	  		
  		
    	<!-- 引入js 这个要在自己的上面-->
    	#@jsModel?()
    	
    	<script type="text/javascript">
    		var common;
    		var $;
    		var layer
			layui.config({base: "JFinalNew/js/"}).use(["layer","jquery","common","form"], function() {
				$ = layui.jquery;
			 	layer = layui.layer;
			    common = layui.common;
			    var form = layui.form();
			    
				reLoad();
				
				
				
				/**easyui上传文件组件*/
				$("#file").filebox({    
				    buttonText: "选择文件", 
				    buttonAlign: "right",
				    height:34
				});
				
				form.on("submit(formDemo)", function(data){
					  var name =$("#name").val();
					  if(!name){
						  common.getMsgBlackDialog("部署名称不能为空",1500);
					  }
					  var fileName =$("#file").filebox("getText");
					  if(fileName){
						  var fileType = fileName.substring(fileName.lastIndexOf(".")+1);
						  if(("zip")==fileType){
							  common.showLoadingDialog();
							   /**异步提交表单开始*/
							  $("#ajaxForm").ajaxSubmit({
									type:"POST",
									url:"activiti/processDelploy.html",
									dataType:"JSON",
									clearForm:true,
									 success:function(data){/**提交成功后执行的回调函数*/
										 common.closeLoadingDialog();
										 if(data.success){
											 common.getMsgBlackDialog("部署成功,前往部署管理查看",1500);
											 reLoad();
										 }else{
											 common.getMsgDialog("出错误了...",5,1500);
										 }
									 } 
								});
							  /**异步提交表单结束*/
						  }else{
							  common.getMsgBlackDialog("只允许上传zip文件类型",1500);
						  }
					  }else{
						  common.getMsgBlackDialog("只允许上传zip文件类型",1500);
					  }
					  return false; 
				});
			});
			/**点击删除按钮*/
			function delBtnClick(btn){
				//要删除部署的id  $(btn).attr("lang")
				if($(btn).attr("lang")){
					common.getConfirmDelDialog("再次确认","确定要进行删除操作吗?",3,"activiti/delDeploy.html",{id:$(btn).attr("lang")},reLoad);
				}else{
					common.getMsgDialog("部署的id不能为空",2,1500);
				}
			}
			/**重新加载列表*/
			function reLoad(){
				/**查询所有的流程定义跟流程部署的列表*/
				common.showLoadingDialog();
				$.ajax({
					   type: "POST",url: "activiti/queryProcssDeployInfoList.html",data: {},dataType: "JSON",
					   success: function(msg){
						 $("#defineBody").empty();
						 $("#deployBody").empty(); 
						 common.closeLoadingDialog();
					     if(msg.success){ 
					    	 var deployMents=msg.lisDeployments;
					    	 var lisProcessDefinitions=msg.lisProcessDefinitions;
					    	 if(deployMents.length == 0){
						    	 $("#deployBody").append('<tr><td></td><td colspan="2" style="text-align: center;"><span style="color: red;">暂无数据</span></td><td></td></tr>');
					    	 }else{
					    		 var deployHtml="";
					    		 for(var i=0;i<deployMents.length;i++){
					    			 var deplotment=deployMents[i];
					    			 deployHtml = deployHtml+'<tr><td style="text-align: center;">'+deplotment.id+'</td><td style="text-align: center;">'+deplotment.name+'</td><td style="text-align: center;">'+deplotment.deploymentTime+'</td><td style="text-align: center;"><button onclick="delBtnClick(this)"  lang="'+deplotment.id+'"  style="height: 25px;line-height:25px;" class="layui-btn layui-btn-small  layui-btn-danger">删除</button></td></tr>';
					    		 }
					    		 $("#deployBody").append(deployHtml);
					    	 }
					    	 if(lisProcessDefinitions.length == 0){
						    	 $("#defineBody").append('<tr><td></td><td colspan="5" style="text-align: center;"><span style="color: red;">暂无数据</span></td><td></td></tr>');
					    	 }else{
					    		 var definitionHtml="";
					    		 for(var i=0;i<lisProcessDefinitions.length;i++){
					    			 var definition=lisProcessDefinitions[i];
					    			 definitionHtml = definitionHtml+'<tr><td style="text-align: center;">'+definition.id+'</td><td style="text-align: center;">'+definition.name+'</td><td style="text-align: center;">'+definition.key+'</td><td style="text-align: center;">'+definition.deploymentId+'</td><td style="text-align: center;">'+definition.diagramResourceName+'</td><td style="text-align: center;">'+definition.resourceName+'</td><td style="text-align: center;">'+definition.version+'</td></tr>';
					    		 }
					    		 $("#defineBody").append(definitionHtml);
					    	 }
					     }else{
					    	 $("#deployBody").append('<tr><td></td><td colspan="2" style="text-align: center;"><span style="color: red;">暂无数据</span></td><td></td></tr>');
					    	 $("#defineBody").append('<tr><td></td><td colspan="2" style="text-align: center;"><span style="color: red;">暂无数据</span></td><td></td></tr>');
					     }
					   }
				});
			}
  		</script>
  </body>
</html>
