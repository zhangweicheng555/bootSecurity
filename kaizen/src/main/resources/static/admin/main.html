<!DOCTYPE html>
<html>
	<head>
		<base href="#(basePath)">
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="JFinalNew/css/main.css" />
		#@cssModel()
	</head>

	<body>
	
		<center>	
			<img alt="暂无照片" src="dyjl/checkTwoCode.html">
		</center>
		  <form class="layui-form" id="formDemo" method="post"  style="margin-top: 5px;">
		  		<div class="layui-form-item">
				    <label class="layui-form-label">下拉选择框</label>
				    <div class="layui-input-block" style="width: 200px;">
				      #@selectElementJF("test",true,codeMap,"")
				    </div>
			    </div>
		  </form>
		
		<button  id="destoryTree" class="layui-btn layui-btn-normal">销毁树</button>
    	<button  id="addNodeThree" class="layui-btn layui-btn-normal">节点添加用addNodes方法</button>
    	<button  id="checkedaddNode" class="layui-btn layui-btn-normal">勾选全部的节点</button>
    	<button  id="expandAllNode" class="layui-btn layui-btn-normal">展开全部的节点</button>
    	<button  id="getCheckedAllNode" class="layui-btn layui-btn-normal">获取全部勾选的集合</button>
    	<button  id="getAllNode" class="layui-btn layui-btn-normal">获取全部节点的集合</button>
    	<button  id="getAllNodeCondition" class="layui-btn layui-btn-normal">获取带省的集合</button>
		#@jsModel()
		#@ztreeModel()
		<script type="text/javascript">
    	/**固定写法*/
		var flag=false;
		var treeObj;
		var common;
		var parentNode=null;
    	layui.config({base: "JFinalNew/js/"}).use(["layer","jquery","form","common"], function() {
				var $ = layui.jquery;
				var layer = layui.layer;
				var form=layui.form();
				common = layui.common;
				 var inputName="";
				 
				 /**获取带省的集合*/
				 $("#getAllNodeCondition").click(function(){
					 var nodes = treeObj.getNodesByFilter(filter); // 查找节点集合
					 treeObj.destroy("treeDemo");
					 treeObj = $.fn.zTree.init($("#treeDemo"), setting, nodes);
				 });
				 /**获取全部的节点的集合*/
				 $("#getAllNode").click(function(){
					// var treeObj = $.fn.zTree.getZTreeObj("tree");   获取这个tree的方法
					 var nodes = treeObj.getNodes();
					 console.info(nodes);
				 });
				 /**获取全部的节点的集合*/
				 $("#getCheckedAllNode").click(function(){
					 var nodes=treeObj.getCheckedNodes(true);
					 console.info(nodes);
				 });
				 /**展开全部的节点*/
				 $("#expandAllNode").click(function(){
					 flag=!flag;
					 treeObj.expandAll(flag);
				 });
				 /**勾选全部的节点*/
				 $("#checkedaddNode").click(function(){
					 flag=!flag;
					 treeObj.checkAllNodes(flag);/**false代表取消全部的勾选*/
				 });
				 /**小根节点添加三个节点*/
				 $("#addNodeThree").click(function(){
					 var newNodes = [{name:"newNode1"}, {name:"newNode2"}, {name:"newNode3"}];
					 treeObj.addNodes(parentNode, newNodes);
					 treeObj.cancelSelectedNode();
				 });
				 /**销毁树*/
				 $("#destoryTree").click(function(){
					 treeObj.destroy("treeDemo");
				 });
				 
				   var setting = {
					   async: {
							enable: true,
							type: "post",
							url: "dyjl/getChildrenNodes.html",
							autoParam: ["id"],
							dataFilter: filter
						},
					   view: {
						   dblClickExpand: true,
						   expandSpeed: "fast",
						   showIcon: true,
						   showLine: true,
						   showTitle: true
						},
						edit: {
							enable: true,
							editNameSelectAll: false,
							removeTitle: "删除",
							renameTitle: "编辑",
							showRenameBtn: showRenameBtn,
							showRemoveBtn: true,
							drag: {
								autoExpandTrigger: true,
								autoOpenTime: 0
							}
						},
					   callback: {
							onExpand: zTreeOnExpand,
							beforeCheck: zTreeBeforeCheck,/**勾选之前判断是不是可以勾选 返回true可以勾选*/
						//	beforeClick:beforeClick,
							beforeDrag: zTreeBeforeDrag,
							beforeDragOpen: zTreeBeforeDragOpen,/**对已经展开的父节点不起作用*/
							beforeDrop: zTreeBeforeDrop,/**这个可用于拖拽结束之后的对拖拽的后台操作*/
							beforeEditName: zTreeBeforeEditName,
							beforeRemove:beforeRemove,
							beforeRename: zTreeBeforeRename,
							//beforeRightClick: zTreeBeforeRightClick,
							onDrop: zTreeOnDrop,
							onRightClick: zTreeBeforeRightClick,
							onClick: zTreeOnClick
					   },
						view: {
							showTitle: showTitleForTree,
							showLine: false
						},
						check: {
							enable: true,
							autoCheckTrigger:true,
							chkStyle: "checkbox",
							chkboxType: { "Y": "p", "N": "ps" }
							/***chkStyle: "radio",
							radioType: "level"*/
						},
						data: {
							keep: {
								parent: true/**保持父节点的属性状态 及时该父节点下的子节点被移除之后 仍旧保持父节点的状态*/
							},
							simpleData: {
								enable: true,
								idKey: "id",
								pIdKey: "pid",
								rootPId: "0"
							},
							key: {/**设置返回node节点的哪些属性对应这几个属性*/
								checked: "isChecked",/**说明节点的属性是可以任意的写的  此外这里指定勾选状态的值 等于返回属性isChecked的值  默认为checked */
							    url: "xUrl",/**设置返回节点的xUrl属性为节点的url*/
							    children: "children",name: "name",title: ""/**如果设置为 "" ，则自动与 setting.data.key.name 保持一致，避免用户反复设置*/
							}
						}
				   };
				   $.ajax({
					   type: "POST",url: "dyjl/queryJsonTree.html",data: {},dataType: "JSON",
					   success: function(msg){
						   console.info(msg);
						   treeObj = $.fn.zTree.init($("#treeDemo"), setting, msg);
					   }
					});
		});
    	
    	function zTreeBeforeCheck(treeId,treeNode){/**如果是父节点 禁止勾选*/
    		console.log(treeId);
    		console.log(treeNode);
    		if(treeNode.isParent){
	    		return true;
    		}else{
	    		return true;
    		}
    	}
    	function showTitleForTree(treeId, treeNode){/**是否显示标题   父节点不显示标题*/
    		if(treeNode.isParent){
	    		return false;
    		}else{
	    		return true;
    		}
    	}
    	function zTreeOnExpand(event, treeId, treeNode){/**调用展开事件*/
    		console.info(treeNode);
    		console.info("展开事件");
    		return treeNode.isParent;
    	}
    	function setFontCss(treeId, treeNode){/**设置字体的css样式*/
    		return treeNode.parent ==false ? {color:"red"} : {};
    	}
    	function beforeClick(treeId, treeNode, clickFlag){/**点击之前的事件*/
    		console.info(treeId);
    		console.info(treeNode);
    		console.info(clickFlag);
    	}
    	function zTreeBeforeDrag(treeId, treeNodes){/**拖拽之前做的操作*/
    		console.info(treeId);
    		console.info(treeNodes);
    	}
    	function zTreeBeforeDragOpen(treeId, treeNode){/**拖拽到父节点展开的事件*/
    		console.info("拖拽到父节点展开的事件");
    		console.info(treeId);
    		console.info(treeNode);
    	}
    	function zTreeBeforeRightClick(event, treeId, treeNode){
    		event.preventDefault();
    		console.info(treeNode);
    		treeObj.cancelSelectedNode();
    		treeObj.checkAllNodes(false);
    		treeObj.checkNode(treeNode, true, false);
    		if(treeNode){
	    		common.openEditDialog(load,"添加树节点","childpayback/editPage.html","750px","350px",false,"childpayback/edit.html");
    		}
    	}
    	function zTreeBeforeEditName(treeId, treeNode){
    		if(treeNode.level == 0){
    			layer.msg("不可以编辑");
    			return false;
    		}
    		inputName=treeNode.name;
    	}
    	function showRenameBtn(treeId, treeNode){
    		return !(treeNode.level == 0);
    	}
    	function beforeRemove(treeId, treeNode){
    		if(treeNode.level==0){
    			layer.msg("根节点不允许被删除");
    			return false;
    		}
    	}
    	function zTreeBeforeRename(treeId, treeNode, newName, isCancel){
    		console.info(treeId);
    		console.info(treeNode);
    		console.info(newName);
    		console.info(isCancel);
    		if(isCancel || newName == inputName){
    			layer.msg("未进行修改操作");
    		}else{
    			$.ajax({
 				   type: "POST",url: "dyjl/renameTree.html",data: {id:treeNode.id,name:newName}, dataType: "JSON",
 				   success: function(msg){
 					   if(!msg.success){
 						   layer.msg("操作失败");
 					   }else{
 						   layer.msg("操作成功");
 					   }
 				   }
 			});
    		}
    	}
    	function zTreeOnDrop(event, treeId, treeNodes, targetNode, moveType){
    		console.info("新的测试");
    		console.info(treeNodes);
    		if(treeNodes[0].level == 0){
    			layer.msg("禁止拖至根节点");
    			return false;
    		}
    	}
    	function zTreeOnClick(event, treeId, treeNode){
    		parentNode=treeNode;
    		/**单击节点的时候 节点处于勾选的状态 并且其他的选中清空*/
    		treeObj.cancelSelectedNode();
    		treeObj.checkAllNodes(false);
    		treeObj.checkNode(treeNode, true, true);
    		
    	}
    	function zTreeBeforeDrop(treeId, treeNodes, targetNode, moveType){/**拖拽结束之前的操作*/
			console.info("拖拽结束之前的操作");    		
			console.info(treeNodes);    		
			var childrenId=treeNodes[0].id;
			var parentId=targetNode.id;
			if(treeNodes[0].level == 0){
    			layer.msg("禁止拖至根节点");
    			return false;
    		}else{
				 $.ajax({
					   type: "POST",url: "dyjl/editTree.html",data: {childrenId:childrenId,parentId:parentId}, dataType: "JSON",
					   success: function(msg){
						   if(!msg.success){
							   layer.msg("操作失败");
							   return false;
						   }else{
							   layer.msg("操作成功");
							   return false;
						   }
					   }
				});
    		}
    	}
    	function cancelSelectedNode(){/**取消全部的节点的选中状态*/
    		treeObj.cancelSelectedNode();
    	}
    	
    	function load(){
    		
    	}
    	function filter(treeId, parentNode, childNodes) {
			if (!childNodes) return null;
			for (var i=0, l=childNodes.length; i<l; i++) {
				childNodes[i].name = childNodes[i].name.replace(/\.n/g, '.');
			}
			return childNodes;
		}
    	/**过滤的函数*/
    	function filter(node) {
    		if(node){
	    	    return (node.level == 1 && node.name.indexOf("省")>-1);
    		}else{
    			return (node.level == 0);
    		}
    	}
    </script>
    	
		 <ul id="treeDemo" class="ztree"></ul>
	</body>

</html>