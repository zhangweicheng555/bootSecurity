<!DOCTYPE html>
<html>
  <head>
    <title>角色分配资源资源</title>
    <base href="#(basePath)"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    	<!-- 引入css -->
    	#@cssModel?()
    	
  </head>
  
  <body class="easyui-layout" style="margin: 10px;">
  		<input type="hidden" name="id"  id="id" value="#(sysrole.id??)" />
  		 <div data-options="region:'north',border:false,height:70">
  		 	<div style="height: 100%;width: 100%;">
  		 	 <blockquote class="layui-elem-quote">
  		 	 	
  		 	 	角色名称:<span style="color: red;">#(sysrole.name??)</span>
				
				<div style="float: right;">
					<div  class="layui-input-inline" title="分配资源"><button  id="sendResource"  class="layui-btn   layui-btn-warm layui-btn-small"   style="margin-left: 1px;"><i class="layui-icon">&#xe609;</i>分配资源</button></div>
					<div  class="layui-input-inline" title="展开全部"><button  id="expandAll"  class="layui-btn    layui-btn-small"   style="margin-left: 1px;"><i class="layui-icon">&#xe624;</i>展开全部</button></div>
					<div  class="layui-input-inline" title="折叠全部"><button  id="closeAll"  class="layui-btn    layui-btn-small"   style="margin-left: 1px;"><i class="layui-icon">&#xe61d;</i>折叠全部</button></div>
		    	</div>
		    </blockquote>
		   </div>
  		 </div>    
	    
	    
	    <div data-options="region:'center',border:false" style="margin-top: 2px;">
	     	 <table id="datagridModel" ></table> 
	    </div> 
  		
  		
  		
  	
  		
  		
    	<!-- 引入js 这个要在自己的上面-->
    	#@jsModel?()
    	
    	<script type="text/javascript">
			layui.config({base: "JFinalNew/js/"}).use(["layer","jquery","common"], function() {
				var $ = layui.jquery;
				var layer = layui.layer;
				var common = layui.common;
				
				
				
				var datagrid;	
				var selectId=0;/**记录是不是第一次加载  第一次加载的话 立马去后台请求 改角色对应的资源的id*/			
				$(function(){
					datagrid=$("#datagridModel").treegrid({    
					    url:"sysresource/queryList.html",  
					    idField:"id",
					    treeField:"name",  
					     columns:[[    
					         {field:"id",title:"编号",width:100,checkbox:true},  
					         {field:"name",title:"资源名称",width:300},   
					         {field: "icon", title: '图标 ', width: 90, fixed:true,align: 'center'},
					         {field: "url", title:  '资源链接', width: 150,fixed:true, align: 'center'},
					         {field: "insertdate", title:  '添加时间', fixed:true,width: 170, align: 'center'},
					         {field: "updatedate", title:  '更新时间', fixed:true,width: 170, align: 'center'},
					         {field: "parentname", title:  '父节点',fixed:true, width: 140, align: 'center'},
					         {field: "sort", title:  '排序', width: 100, align: 'center'},
					         {field: "remark", title:  '描述', width: 400, align: 'center'}
					    ]],
					    autoRowHeight:false,
					    fitColumns: true,
					    striped:true,
					    nowrap:true,
					    loadMsg:"拼命加载中...",
					    singleSelect:false,
					    checkOnSelect:true,
					    selectOnCheck:true,
					    fit:true,
					    onLoadSuccess:function(){
					    	/**发请求 请求该角色的id对应的资源*/
					    	if(selectId == 0){/**第一次加载*/
					    		$.ajax({
								   type: "POST",url: "sysresource/queryResourcesByRoleId.html",data:{roleId:$("#id").val()} ,dataType: "json",
								   success: function(msg){
									   	for(var i=0;i<msg.length;i++){
									   		datagrid.treegrid("select",msg[i]);
									   	}
									   	selectId=1;
								   }
							  });
					    	}
					    }
					}); 
				});
				
				/**展开全部*/
				$("#expandAll").click(function(){
					expandAll();
				});
				/**折叠全部*/
				$("#closeAll").click(function(){
					datagrid.treegrid("collapseAll");
				});
				
				/**重载所有的行*/
				function reload(){
					datagrid.treegrid("load");
					datagrid.treegrid("expandAll");
				}
				
				/**展开全部*/
				function expandAll(){
					datagrid.treegrid("expandAll");
				}
				
				/**分配资源*/
				$("#sendResource").click(function(){
					var rows=datagrid.treegrid("getSelections");
					if(rows.length > 0){
						var recordId=$("#id").val();
						var ids=[];
						for(var i=0;i<rows.length;i++){
							ids.push(rows[i].id);
						}
						 parent.layer.confirm('您确定要提交吗?', {icon: 3, title:'再次确认'}, function(index){
							  parent.layer.close(index);
							  /**发送ajax*/
							  $.ajax({
								   type: "POST",url: "sysrole/sendResourceToRole.html",data:{id:recordId,ids:ids.join(",")} ,dataType: "json",
								   success: function(msg){
									   if(msg.success){
										   common.getMsgBlackDialog(msg.msg,2000);
										   reload();
								       }else{
										   common.getMsgBlackDialog("操作失败...",2000);
								       }
								   }
							  });
					   });
					}else{
						common.getMsgBlackDialog("请选中要分配的资源",2000);
						return ;
					}
				});
			});
  		</script>
  </body>
</html>
